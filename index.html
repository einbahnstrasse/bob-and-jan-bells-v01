<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bob & Jan's Bells</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #121212;
      color: #ffffff;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .title {
      text-align: center;
      margin: 20px;
    }

    .byline {
      font-size: 0.9em;
      color: #bbb;
      margin: 2px;
    }

    .byline a {
      color: #bbb;
      text-decoration: underline;
    }

    .container {
      width: 90%;
      max-width: 600px;
      margin: 20px auto;
    }

    canvas {
      width: 100%;
      height: 100px;
      background: #222;
      margin-bottom: 10px;
      border: 1px solid #444;
    }

    .label {
      position: absolute;
      font-size: 0.8em;
      color: #aaa;
      padding: 4px;
    }

    .graph-wrapper {
      position: relative;
      margin-bottom: 10px;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
      margin-left: 10px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 34px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #2196f3;
    }

    input:checked + .slider:before {
      transform: translateX(26px);
    }

    #splash {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      color: #fff;
      display: none;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 20px;
      z-index: 999;
    }

    #closeSplash {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 2em;
      cursor: pointer;
    }

    .controls {
      text-align: center;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="title">
    <h1>Bob & Jan's Bells</h1>
    <div class="byline">
      <a href="https://louisgoldford.com" target="_blank">Love, Louis and Eszter</a>
    </div>
    <div class="byline">
      <a href="#" onclick="document.getElementById('splash').style.display='flex'">What the hell is this thing?</a>
    </div>
  </div>
  <div id="splash">
    <div id="closeSplash" onclick="document.getElementById('splash').style.display='none'">&times;</div>
    <p>This is a placeholder explanation. Replace me with an actual description of what this does.</p>
  </div>
  <div class="container">
    <div class="graph-wrapper">
      <canvas id="graphX"></canvas>
      <div class="label" id="labelX" style="bottom: 10px; left: 10px;">X: 0</div>
    </div>
    <div class="graph-wrapper">
      <canvas id="graphY"></canvas>
      <div class="label" id="labelY" style="bottom: 10px; left: 10px;">Y: 0</div>
    </div>
    <div class="graph-wrapper">
      <canvas id="graphZ"></canvas>
      <div class="label" id="labelZ" style="bottom: 10px; left: 10px;">Z: 0</div>
    </div>
    <div class="controls">
      <label for="darkModeToggle">Dark Mode</label>
      <label class="switch">
        <input type="checkbox" id="darkModeToggle" checked>
        <span class="slider"></span>
      </label>
    </div>
    <div class="controls">
      <select id="sampleSelector">
        <option value="https://www.dropbox.com/scl/fi/zxydx1cw718q9qlzzsc4o/archeos-bell.wav?rlkey=shbjs89f380k4wmj9i0uanjo0&dl=1">archeos-bell.wav</option>
      </select>
    </div>
    <div class="controls">
      <button onclick="initAudioAndGyro()">Enable Gyro</button>
    </div>
  </div>

  <script>
    const BUFFER_SIZE = 128;
    const graphLength = 200;
    const epsilon = 0.5;

    let xData = [], yData = [], zData = [];
    let audioCtx;
    let sourceBuffer;
    let isPlaying = false;
    let grainInterval;

    const graphX = document.getElementById("graphX");
    const graphY = document.getElementById("graphY");
    const graphZ = document.getElementById("graphZ");
    const ctxX = graphX.getContext("2d");
    const ctxY = graphY.getContext("2d");
    const ctxZ = graphZ.getContext("2d");
    const labelX = document.getElementById("labelX");
    const labelY = document.getElementById("labelY");
    const labelZ = document.getElementById("labelZ");

    function drawGraph(ctx, data, color) {
      ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
      const w = ctx.canvas.width;
      const h = ctx.canvas.height;
      const max = Math.max(...data, 1);
      const min = Math.min(...data, -1);
      ctx.beginPath();
      ctx.strokeStyle = color;
      data.forEach((v, i) => {
        const x = (i / graphLength) * w;
        const y = h - ((v - min) / (max - min)) * h;
        ctx.lineTo(x, y);
      });
      ctx.stroke();
    }

    function updateGraphs(x, y, z) {
      xData.push(x); if (xData.length > graphLength) xData.shift();
      yData.push(y); if (yData.length > graphLength) yData.shift();
      zData.push(z); if (zData.length > graphLength) zData.shift();
      drawGraph(ctxX, xData, "red");
      drawGraph(ctxY, yData, "green");
      drawGraph(ctxZ, zData, "blue");
      labelX.innerText = `X: ${x.toFixed(2)}`;
      labelY.innerText = `Y: ${y.toFixed(2)}`;
      labelZ.innerText = `Z: ${z.toFixed(2)}`;
    }

    function loadSample(url) {
      return fetch(url)
        .then(r => r.arrayBuffer())
        .then(ab => audioCtx.decodeAudioData(ab));
    }

    function playGrain(buffer, position, duration = 0.1, playbackRate = 1.0) {
      const src = audioCtx.createBufferSource();
      src.buffer = buffer;
      src.playbackRate.value = playbackRate;
      const gain = audioCtx.createGain();
      gain.gain.value = 0.05; // low gain
      src.connect(gain).connect(audioCtx.destination);
      src.start(audioCtx.currentTime, position, duration);
    }

    function startGranularEngine() {
      if (!sourceBuffer) return;
      grainInterval = setInterval(() => {
        if (Math.abs(lastX) < epsilon && Math.abs(lastY) < epsilon && Math.abs(lastZ) < epsilon) return;
        const fileDuration = sourceBuffer.duration;
        const position = (Math.abs(lastZ) % 1) * fileDuration;
        const duration = 0.05 + Math.abs(lastX) * 0.02;
        const pitch = 0.5 + Math.abs(lastY) * 0.1;
        playGrain(sourceBuffer, position, duration, pitch);
      }, 100);
    }

    let lastX = 0, lastY = 0, lastZ = 0;

    function initAudioAndGyro() {
      if (isPlaying) return;
      isPlaying = true;
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const sampleURL = document.getElementById("sampleSelector").value;
      loadSample(sampleURL).then(buf => {
        sourceBuffer = buf;
        startGranularEngine();
      });
      window.addEventListener("devicemotion", e => {
        const r = e.rotationRate;
        if (!r) return;
        lastX = r.beta || 0;
        lastY = r.gamma || 0;
        lastZ = r.alpha || 0;
        updateGraphs(lastX, lastY, lastZ);
      });
    }

    document.getElementById("darkModeToggle").addEventListener("change", function () {
      document.body.style.backgroundColor = this.checked ? "#121212" : "#ffffff";
      document.body.style.color = this.checked ? "#ffffff" : "#000000";
    });
  </script>
</body>
</html>
