<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bob & Jan's Bells</title>
  <style>
    body {
      background-color: #121212;
      color: #ffffff;
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    h1 {
      margin-top: 20px;
    }
    .byline {
      font-size: 0.8em;
      margin-top: -5px;
    }
    .byline a {
      color: #cccccc;
    }
    .graph {
      width: 90%;
      max-width: 400px;
      height: 100px;
      background-color: #222;
      margin: 20px auto;
      position: relative;
      border: 1px solid #555;
    }
    .value-label {
      position: absolute;
      bottom: 5px;
      left: 5px;
      font-size: 0.7em;
      color: #aaa;
    }
    .toggle-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 10px;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
      margin-left: 10px;
    }
    .switch input {display:none;}
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #2196F3;
    }
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    canvas {
      width: 100%;
      height: 100%;
    }
    #debugLog {
      margin: 20px;
      font-size: 0.8em;
      color: #ccc;
      white-space: pre-line;
      text-align: left;
    }
  </style>
</head>
<body>
  <h1>Bob & Jan's Bells</h1>
  <div class="byline">
    <a href="https://louisgoldford.com" target="_blank">Love, Louis and Eszter</a><br />
    <a href="#" onclick="showSplash()">What the hell is this thing?</a>
  </div>

  <div class="toggle-container">
    <label for="darkModeToggle">Dark Mode</label>
    <label class="switch">
      <input type="checkbox" id="darkModeToggle" checked>
      <span class="slider"></span>
    </label>
  </div>

  <div class="graph" id="graphX">
    <canvas id="canvasX"></canvas>
    <div class="value-label" id="labelX">X: 0</div>
  </div>
  <div class="graph" id="graphY">
    <canvas id="canvasY"></canvas>
    <div class="value-label" id="labelY">Y: 0</div>
  </div>
  <div class="graph" id="graphZ">
    <canvas id="canvasZ"></canvas>
    <div class="value-label" id="labelZ">Z: 0</div>
  </div>

  <button id="enableButton">Enable Gyro</button>
  <select id="soundSelect">
    <option value="https://www.dropbox.com/scl/fi/zxydx1cw718q9qlzzsc4o/archeos-bell.wav?rlkey=shbjs89f380k4wmj9i0uanjo0&st=892d95ca&dl=1">archeos-bell.wav</option>
  </select>

  <div id="debugLog"></div>

  <script>
    const debugLog = document.getElementById("debugLog");
    function logDebug(msg) {
      debugLog.textContent += msg + "\n";
    }

    const canvasX = document.getElementById("canvasX");
    const canvasY = document.getElementById("canvasY");
    const canvasZ = document.getElementById("canvasZ");
    const ctxX = canvasX.getContext("2d");
    const ctxY = canvasY.getContext("2d");
    const ctxZ = canvasZ.getContext("2d");
    canvasX.width = canvasY.width = canvasZ.width = 400;
    canvasX.height = canvasY.height = canvasZ.height = 100;

    const buffers = { X: [], Y: [], Z: [] };
    const maxBufferLength = 200;

    function drawGraph(ctx, buffer, label, labelElem) {
      ctx.clearRect(0, 0, canvasX.width, canvasX.height);
      ctx.beginPath();
      for (let i = 0; i < buffer.length; i++) {
        const x = (i / maxBufferLength) * canvasX.width;
        const y = canvasX.height / 2 - buffer[i] * 30;
        ctx.lineTo(x, y);
      }
      ctx.strokeStyle = "#0f0";
      ctx.stroke();
      labelElem.textContent = `${label}: ${buffer.at(-1)?.toFixed(2) || 0}`;
    }

    const darkToggle = document.getElementById("darkModeToggle");
    darkToggle.addEventListener("change", () => {
      document.body.style.backgroundColor = darkToggle.checked ? "#121212" : "#ffffff";
      document.body.style.color = darkToggle.checked ? "#ffffff" : "#000000";
    });

    let audioCtx, sourceBuffer, granularNode;
    let lastGrainTime = 0;

    function initAudio() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        logDebug("AudioContext initialized.");
      }
    }

    async function loadSound(url) {
      logDebug("Loading sound...");
      const response = await fetch(url);
      const arrayBuffer = await response.arrayBuffer();
      sourceBuffer = await audioCtx.decodeAudioData(arrayBuffer);
      logDebug("Sound decoded.");
    }

    function playGrain(position, duration, playbackRate) {
      if (!sourceBuffer) return;
      const now = audioCtx.currentTime;
      if (now - lastGrainTime < 0.1) return;
      lastGrainTime = now;
      const src = audioCtx.createBufferSource();
      const gain = audioCtx.createGain();
      src.buffer = sourceBuffer;
      src.playbackRate.value = playbackRate;
      const grainStart = Math.max(0, position);
      src.connect(gain).connect(audioCtx.destination);
      src.start(now, grainStart, duration);
      src.stop(now + duration);
    }

    document.getElementById("enableButton").addEventListener("click", async () => {
      initAudio();
      await audioCtx.resume();
      logDebug("AudioContext resumed.");
      await loadSound(document.getElementById("soundSelect").value);

      window.addEventListener("devicemotion", (event) => {
        const x = event.rotationRate.alpha || 0;
        const y = event.rotationRate.beta || 0;
        const z = event.rotationRate.gamma || 0;
        buffers.X.push(x);
        buffers.Y.push(y);
        buffers.Z.push(z);
        if (buffers.X.length > maxBufferLength) buffers.X.shift();
        if (buffers.Y.length > maxBufferLength) buffers.Y.shift();
        if (buffers.Z.length > maxBufferLength) buffers.Z.shift();
        drawGraph(ctxX, buffers.X, "Alpha (Z)", document.getElementById("labelX"));
        drawGraph(ctxY, buffers.Y, "Beta (X)", document.getElementById("labelY"));
        drawGraph(ctxZ, buffers.Z, "Gamma (Y)", document.getElementById("labelZ"));

        const movement = Math.abs(x) + Math.abs(y) + Math.abs(z);
        if (movement > 5 && sourceBuffer) {
          const pos = (Math.abs(y) % 1) * sourceBuffer.duration;
          const dur = 0.1 + Math.abs(z) * 0.02;
          const rate = 0.8 + Math.abs(x) * 0.01;
          playGrain(pos, dur, rate);
          logDebug(`Grain @ ${pos.toFixed(2)}s dur ${dur.toFixed(2)} rate ${rate.toFixed(2)}`);
        }
      });
    });

    function showSplash() {
      alert("This will explain what the hell this thing is doing. (Placeholder)");
    }
  </script>
</body>
</html>
